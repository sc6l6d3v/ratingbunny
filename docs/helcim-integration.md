# Helcim integration

Rating Bunny provisions Helcim resources directly during `/auth/signup` for paid
plans. The backend now uses the [`helcim4s`](https://github.com/iscs/helcim4s)
client to orchestrate the following workflow when `plan` is either
`pro_monthly` or `pro_yearly`:

1. Create a Helcim customer using the contact and address information supplied
   in the signup payload.
2. Enrol the new customer into the configured payment plan (monthly or annual).
3. Capture the resulting subscription metadata and persist it alongside the
   user's account so future billing and reconciliation can run through Helcim.

Free plans skip the billing workflow entirely.

## Environment variables

| Variable | Description | Default |
| --- | --- | --- |
| `HELCIM4S_MODE` | `live` to reach Helcim's production API, `stub` to use the in-memory testkit. | `stub` |
| `HELCIM_API_TOKEN` | API token issued by Helcim. Required in `live` mode. | `stub-token` in stub mode |
| `PROMONTHLY` | Helcim plan ID for the monthly subscription. | `21361` |
| `PROANNUAL` | Helcim plan ID for the annual subscription. | `21362` |
| `HELCIM_DEFAULT_CURRENCY` | Fallback ISO currency code when Helcim does not return one. | `USD` |

Set `HELCIM4S_MODE=live` together with a valid `HELCIM_API_TOKEN` in
production. In `stub` mode the flow runs entirely in-process using the
`helcim4s-testkit` stubbed client.

## Library entry points

The billing workflow relies on the [`HelcimClient` type that ships with the
`helcim4s` core module](https://github.com/iscs/helcim4s/blob/main/modules/core/src/main/scala/com/iscs/helcim4s/core/HelcimClient.scala).
It is imported from `com.iscs.helcim4s.core.HelcimClient` and provided by the
library's client builder/testkit helpers at runtime, so no project-local
implementation is required.

## Signup payload

Paid signups must include a `billing` object that provides enough context to
create the Helcim customer:

```json
{
  "email": "customer@example.com",
  "password": "hunter2",
  "plan": "pro_monthly",
  "billing": {
    "fullName": "Jane Doe",
    "cardToken": "tok_test_visa_4242",
    "address": {
      "line1": "123 Example St",
      "city": "Calgary",
      "state": "AB",
      "postalCode": "T2P 1J9",
      "country": "CA"
    }
  }
}
```

`cardToken` is the opaque token generated by HelcimPay.js or the Helcim REST
tokenization endpoints. Line 2 for addresses can be supplied through
`address.line2`.

On success the backend stores the Helcim customer identifier, the provided card
token and a snapshot of the subscription (plan ID, status, currency, next bill
date, amount in cents). Any provisioning failure returns HTTP 500 with a generic
`failed to provision billing` error message.

## Local development tips

* Run with `HELCIM4S_MODE=stub` to exercise the happy path without contacting
  Helcim.
* Override `PROMONTHLY`/`PROANNUAL` to match IDs from your Helcim account.
* Set `HELCIM_DEFAULT_CURRENCY` if your plans bill in a currency other than
  USD.
